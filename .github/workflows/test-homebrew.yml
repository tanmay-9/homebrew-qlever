name: Test Homebrew Formula

on:
  workflow_dispatch:  # Allow manual triggers

jobs:
  test-homebrew-install:
    runs-on: macos-14

    steps:
      - name: Check runner architecture
        run: |
          echo "Architecture: $(uname -m)"
          echo "macOS version: $(sw_vers -productVersion)"
          echo "Runner: ${{ matrix.os }}"

      - name: Update Homebrew
        run: brew update

      - name: Tap qlever repository
        run: brew tap qlever-dev/qlever

      - name: Install qlever
        run: brew install qlever

      - name: Run Homebrew formula tests
        run: brew test qlever-dev/qlever/qlever

      - name: Verify binaries are installed
        run: |
          which qlever-server
          which qlever-index
          which qlever

      - name: Test qlever-index
        run: |
          qlever-index --version
          qlever-index --help

      - name: Test qlever-server
        run: |
          qlever-server --version
          qlever-server --help
      
      - name: Test qlever-control
        run: |
          qlever --version
          qlever --help

      - name: Verify Qleverfiles have SYSTEM = native
        run: |
          # Find Qleverfiles in Homebrew's virtualenv
          QLEVER_FILES=$(brew --prefix qlever-control)/libexec/lib/python*/site-packages/qlever/Qleverfiles
          echo "Qleverfiles location: $QLEVER_FILES"

          # Check all Qleverfiles for SYSTEM setting
          echo "Checking Qleverfiles for SYSTEM = native..."
          for f in $QLEVER_FILES/*; do
            if [ -f "$f" ]; then
              echo "Checking: $f"
              if grep -qi "^\s*SYSTEM\s*=\s*docker" "$f"; then
                echo "ERROR: Found SYSTEM = docker in $f"
                grep -i "SYSTEM" "$f"
                exit 1
              fi
              if grep -qi "^\s*SYSTEM\s*=\s*native" "$f"; then
                echo "OK: SYSTEM = native"
              else
                echo "WARNING: No SYSTEM setting found in $f"
              fi
            fi
          done
          echo "All Qleverfiles verified!"

      - name: Verify dynamic libraries resolve
        run: |
          echo "=== qlever-server dependencies ==="
          otool -L $(which qlever-server)
          echo ""
          echo "=== qlever-index dependencies ==="
          otool -L $(which qlever-index)

      - name: Test qlever script for olympics dataset (native is default)
        timeout-minutes: 3
        run: |
          mkdir -p qlever-indices/olympics && cd $_
          qlever setup-config olympics

          # Verify the generated Qleverfile has SYSTEM = native
          echo "Generated Qleverfile SYSTEM setting:"
          grep -i "SYSTEM" Qleverfile

          # Run without --system flag to verify native is the default
          qlever get-data
          qlever index
          qlever start
          qlever status
          qlever query
          qlever stop
          ls -lh
