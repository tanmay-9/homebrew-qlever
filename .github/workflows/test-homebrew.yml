name: Test Homebrew Formula

on:
  workflow_dispatch:  # Allow manual triggers

jobs:
  test-homebrew-install:
    runs-on: macos-14

    steps:
      - name: Check runner architecture
        run: |
          echo "Architecture: $(uname -m)"
          echo "macOS version: $(sw_vers -productVersion)"
          echo "Runner: ${{ matrix.os }}"

      - name: Update Homebrew
        run: brew update

      - name: Tap qlever repository
        run: brew tap qlever-dev/qlever

      - name: Install qlever
        run: brew install qlever

      - name: Run Homebrew formula tests
        run: brew test qlever-dev/qlever/qlever

      - name: Verify binaries are installed
        run: |
          which qlever-server
          which qlever-index
          which qlever

      - name: Test qlever-index
        run: |
          qlever-index --version
          qlever-index --help

      - name: Test qlever-server
        run: |
          qlever-server --version
          qlever-server --help
      
      - name: Test qlever-control
        run: |
          qlever --version
          qlever --help

      - name: Verify dynamic libraries resolve
        run: |
          echo "=== qlever-server dependencies ==="
          otool -L $(which qlever-server)
          echo ""
          echo "=== qlever-index dependencies ==="
          otool -L $(which qlever-index)

      - name: Test qlever script for olympics dataset, without Docker
        timeout-minutes: 3
        run: |
          mkdir -p qlever-indices/olympics && cd $_
          qlever setup-config olympics
          qlever get-data
          qlever index --system native
          qlever start --system native
          qlever status
          qlever query
          qlever stop
          ls -lh
